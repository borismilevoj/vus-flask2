{% extends "base.html" %}
{% block title %}Kri≈æanka | VUS{% endblock %}

{% block content %}
<style>
  #wrap { display: grid; grid-template-columns: 1fr 340px; gap: 16px; }
  #grid { display: grid; gap: 2px; }
  .cell { position: relative; width: 40px; height: 40px; background:#fff; border:1px solid #ddd; }
  .cell.black { background:#333; border-color:#333; }
  .cell input { width:100%; height:100%; border:none; text-align:center; font-size:20px; text-transform:uppercase; }
  .cell-number { position:absolute; top:2px; left:4px; font-size:10px; color:#666; }
  .highlight { outline:2px solid #3b82f6; outline-offset:-2px; }
  .correct { background:#e6ffe6 !important; }
  .incorrect { background:#ffe6e6 !important; }
  #opisKartica { display:none; flex-direction:column; gap:12px; border:1px solid #ddd; border-radius:12px; padding:12px; background:#fafafa; }
  #karticaOpis { font-size:16px; line-height:1.35; }
  #karticaSlika { max-width:100%; height:auto; border-radius:8px; border:1px solid #eee; }
  .toolbar { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
</style>

<div class="toolbar">
  <button class="btn btn-primary btn-sm" onclick="zamenjajSmer()">‚ÜïÔ∏è Zamenjaj smer</button>
  <button class="btn btn-secondary btn-sm" onclick="preklopiKartico()">üõà Prika≈æi/Skrij opis</button>
  <span id="statusSmer" class="ms-2">Smer vnosa: vodoravno</span>
</div>

<div id="wrap">
  <div id="grid" aria-label="Mre≈æa kri≈æanke"></div>

  <aside id="opisKartica">
    <div id="karticaOpis">Klikni na polje za prikaz opisa</div>
    <img id="karticaSlika" alt="Slika k opisu (ƒçe obstaja)">
  </aside>
</div>

<script>
// --- normalizacija naziva slike ---
function normalizirajNaziv(opis) {
  return opis
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[-‚Äì‚Äî‚àí‚Ä†().,]/g, '')
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, '')
    .trim()
    .split(/\s+/)
    .slice(0, 15)
    .join('_');
}

let trenutnaSmer = 'across';
let aktivniX = null;
let aktivniY = null;

// === DATUMSKO-VEZAN KLJUƒå ZA SHRANJEVANJE STANJA ===
const datumFromServer = "{{ datum|default('', true) }}"; // iz Flask-a
const datumFromUrl = (location.pathname.match(/\/krizanka\/(\d{4}-\d{2}-\d{2})/) || [,''])[1];
const PUZZLE_ID = datumFromServer || datumFromUrl || new Date().toISOString().slice(0,10);
// tip hrambe: localStorage (ohrani med sejami) ali sessionStorage (izbri≈°e se ob zaprtju brskalnika)
const storage = window.localStorage;
const krizankaKey = `krizanka-rezultat-${PUZZLE_ID}`;
// enkratni cleanup starega kljuƒça brez datuma (ƒçe si prej shranjeval na /krizanka)
try { storage.removeItem("krizanka-rezultat-/krizanka"); } catch(e) {}

function shraniKrizanko() {
  const polja = Array.from(document.querySelectorAll("#grid input"))
    .map(inp => ({x: inp.dataset.x, y: inp.dataset.y, val: inp.value}));
  try { storage.setItem(krizankaKey, JSON.stringify(polja)); } catch(e){}
}

function obnoviKrizanko() {
  try {
    const shrani = storage.getItem(krizankaKey);
    if (!shrani) return;
    const polja = JSON.parse(shrani);
    for (const p of polja) {
      const inp = document.querySelector(`input[data-x='${p.x}'][data-y='${p.y}']`);
      if (inp) inp.value = p.val;
    }
  } catch(e){}
}

function zamenjajSmer() {
  trenutnaSmer = (trenutnaSmer === 'across') ? 'down' : 'across';
  const smerTxt = (trenutnaSmer === 'across' ? 'vodoravno' : 'navpiƒçno');
  document.getElementById('statusSmer').textContent = "Smer vnosa: " + smerTxt;
  if (aktivniX !== null && aktivniY !== null) prikaziOpis(aktivniX, aktivniY);
}

function preklopiKartico() {
  const kartica = document.getElementById('opisKartica');
  kartica.style.display = (kartica.style.display === "none" || kartica.style.display === "") ? "flex" : "none";
}

function premakniNaprej(input) {
  let x = +input.dataset.x;
  let y = +input.dataset.y;
  while (true) {
    x = (trenutnaSmer === 'across') ? x + 1 : x;
    y = (trenutnaSmer === 'down') ? y + 1 : y;
    const next = document.querySelector(`input[data-x='${x}'][data-y='${y}']`);
    if (!next) break;
    if (!next.classList.contains('correct')) { next.focus(); break; }
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const grid = document.getElementById('grid');
  const width = {{ podatki.sirina }};
  const height = {{ podatki.visina }};
  const crna_polja = {{ podatki.crna_polja | tojson }};
  const gesla_opisi = {{ podatki.gesla_opisi | tojson }};
  grid.style.gridTemplateColumns = `repeat(${width}, 40px)`;

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const cell = document.createElement('div');
      cell.classList.add('cell');

      if (crna_polja.some(p => p[0] === x && p[1] === y)) {
        cell.classList.add('black');
      } else {
        const input = document.createElement('input');
        input.setAttribute('maxlength', '1');
        input.dataset.x = x; input.dataset.y = y;
        cell.appendChild(input);

        const geslo = gesla_opisi.find(g => g.x === x && g.y === y);
        if (geslo && geslo.stevilka !== '?') {
          const numberDiv = document.createElement('div');
          numberDiv.classList.add('cell-number');
          numberDiv.textContent = geslo.stevilka;
          cell.appendChild(numberDiv);
        }

        input.addEventListener('input', () => {
          preveriCelotnoGeslo(input);
          if (input.value) premakniNaprej(input);
          shraniKrizanko();
        });
        input.addEventListener('click', () => { prikaziOpis(x, y); });
      }
      grid.appendChild(cell);
    }
  }

  // obnovi stanje za ta datum
  obnoviKrizanko();

  function prikaziOpis(x, y) {
    aktivniX = x; aktivniY = y;
    document.getElementById('opisKartica').style.display = "flex";
    document.querySelectorAll('.cell').forEach(c => c.classList.remove('highlight'));

    const geslo = gesla_opisi.find(g =>
      g.smer === trenutnaSmer &&
      ((g.smer === 'across' && g.y === y && x >= g.x && x < g.x + g.dolzina) ||
       (g.smer === 'down' && g.x === x && y >= g.y && y < g.y + g.dolzina)));

    const opisPolje = document.getElementById('karticaOpis');
    const slikaImg = document.getElementById('karticaSlika');

    if (geslo) {
      for (let i = 0; i < geslo.dolzina; i++) {
        const tx = geslo.smer === 'across' ? geslo.x + i : geslo.x;
        const ty = geslo.smer === 'down' ? geslo.y + i : geslo.y;
        const inp = document.querySelector(`input[data-x='${tx}'][data-y='${ty}']`);
        if (inp) inp.parentElement.classList.add('highlight');
      }

      const opisZaPrikaz = `${geslo.stevilka}. ${geslo.opis}`;
      opisPolje.textContent = opisZaPrikaz;

      // Pametno poi≈°ƒçi sliko (jpg, png, webp)
      const rezultat = normalizirajNaziv(geslo.opis);
      const koncnice = ['jpg', 'png', 'webp'];
      function nastaviSliko(i) {
        if (i >= koncnice.length) { slikaImg.src = ""; return; }
        const pot = `/static/Images/${rezultat}.${koncnice[i]}`;
        slikaImg.src = pot;
        slikaImg.onerror = () => nastaviSliko(i + 1);
      }
      nastaviSliko(0);
    } else {
      opisPolje.textContent = 'Klikni na polje za prikaz opisa';
      slikaImg.src = "";
    }
  }

  function preveriCelotnoGeslo(input) {
    const x = +input.dataset.x;
    const y = +input.dataset.y;
    const geslo = gesla_opisi.find(g =>
      (g.smer === 'across' && g.y === y && x >= g.x && x < g.x + g.dolzina) ||
      (g.smer === 'down' && g.x === x && y >= g.y && y < g.y + g.dolzina));
    if (!geslo) return;

    const vnosPolja = [];
    for (let i = 0; i < geslo.dolzina; i++) {
      const tx = geslo.smer === 'across' ? geslo.x + i : geslo.x;
      const ty = geslo.smer === 'down' ? geslo.y + i : geslo.y;
      const inp = document.querySelector(`input[data-x='${tx}'][data-y='${ty}']`);
      if (inp) vnosPolja.push(inp);
    }

    // primerjaj znak-po-znak (upo≈°tevaj ƒå≈†≈Ω)
    const resitev = geslo.solution.replace(/[^A-Zƒå≈†≈Ω]/gi, '').toUpperCase();
    for (let i = 0; i < vnosPolja.length; i++) {
      const inp = vnosPolja[i];
      const znak = (inp.value || '').toUpperCase();
      inp.classList.remove('correct', 'incorrect');
      if (!znak.match(/[A-Zƒå≈†≈Ω]/)) continue;
      const index = (geslo.smer === 'across')
        ? (+inp.dataset.x - geslo.x)
        : (+inp.dataset.y - geslo.y);
      if (znak === resitev[index]) inp.classList.add('correct');
      else inp.classList.add('incorrect');
    }
  }
});
</script>
{% endblock %}
