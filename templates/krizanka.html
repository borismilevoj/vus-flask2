{% extends "base.html" %}
{% block title %}Kri≈æanka | VUS{% endblock %}

{% block content %}
<style>
  #wrap { display: grid; grid-template-columns: 1fr 340px; gap: 16px; }
  #grid { display: grid; gap: 2px; }
  .cell { position: relative; width: 40px; height: 40px; background:#fff; border:1px solid #ddd; }
  .cell.black { background:#333; border-color:#333; }
  .cell input { width:100%; height:100%; border:none; text-align:center; font-size:20px; text-transform:uppercase; }
  .cell-number { position:absolute; top:2px; left:4px; font-size:10px; color:#666; }
  .highlight { outline:2px solid #3b82f6; outline-offset:-2px; }
  .correct { background:#e6ffe6 !important; }
  .incorrect { background:#ffe6e6 !important; }

  /* --- Plavajoƒça (draggable) kartica z roƒçajem --- */
  #opisKartica {
    position: fixed;
    top: 90px;
    right: 16px;                 /* default: sidra na desni */
    width: min(380px, 90vw);
    max-height: 70vh;
    overflow: auto;
    z-index: 9999;
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.12);
    touch-action: none;          /* omogoƒçi drag na mobilnikih */
    display: none;               /* poka≈æemo ob prvem kliku */
  }
  #opisKartica.dragging { cursor: grabbing; }
  #karticaHandle {
    display:flex; align-items:center; gap:8px;
    padding:6px 10px; background:#eee; border-bottom:1px solid #ddd;
    font-weight:600; user-select:none; cursor:grab;
    border-top-left-radius: 12px; border-top-right-radius: 12px;
  }
  #karticaBody { padding: 10px; }
  #karticaOpis { font-size:16px; line-height:1.35; }
  #karticaSlika { max-width:100%; height:auto; border:1px solid #eee; border-radius:8px; }

  /* --- Plavajoƒçi gumb za smer (tudi draggable) --- */
  #floatSmerBtn {
    position: fixed;
    left: 16px; bottom: 16px;
    z-index: 10000;
    width: 56px; height: 56px; border-radius: 50%;
    box-shadow: 0 8px 24px rgba(0,0,0,.18);
    touch-action: none;
  }
</style>

<div class="d-flex justify-content-end mb-3">
  <a class="btn btn-secondary" href="/krizanka/arhiv">üìÇ Arhiv kri≈æank</a>
</div>

<div id="wrap">
  <div id="grid" aria-label="Mre≈æa kri≈æanke"></div>
</div>

<!-- Plavajoƒça kartica z roƒçajem -->
<aside id="opisKartica">
  <div id="karticaHandle">‚ò∞ Opis</div>
  <div id="karticaBody">
    <div id="karticaOpis">Klikni na polje za prikaz opisa</div>
    <img id="karticaSlika" alt="Slika k opisu (ƒçe obstaja)">
  </div>
</aside>

<!-- Plavajoƒçi gumb za spremembo smeri -->
<button id="floatSmerBtn" class="btn btn-primary" title="Spremeni smer" onclick="zamenjajSmer()">‚ÜïÔ∏è</button>

{% endblock %}

{% block scripts %}
<script>
/* ====== Helper: ime slike iz opisa ====== */
function normalizirajNaziv(opis) {
  return (opis || '')
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[-‚Äì‚Äî‚àí‚Ä†().,]/g, '')
    .toLowerCase().replace(/[^a-z0-9\s]/g, '')
    .trim().split(/\s+/).slice(0, 15).join('_');
}

/* ====== Globalno stanje ====== */
let trenutnaSmer = 'across';
let aktivniX = null, aktivniY = null;

/* ====== Datumsko vezan ID (za shranjevanje stanja in pozicij) ====== */
const datumFromServer = "{{ datum|default('', true) }}";
const datumFromUrl = (location.pathname.match(/\/krizanka\/(\d{4}-\d{2}-\d{2})/) || [,''])[1];
const PUZZLE_ID = datumFromServer || datumFromUrl || new Date().toISOString().slice(0,10);

/* ====== Shrani / Obnovi vnos mre≈æe (per-datum) ====== */
const storage = window.localStorage;
const krizankaKey = `krizanka-rezultat-${PUZZLE_ID}`;
function shraniKrizanko() {
  const polja = Array.from(document.querySelectorAll("#grid input"))
    .map(inp => ({x: inp.dataset.x, y: inp.dataset.y, val: inp.value}));
  try { storage.setItem(krizankaKey, JSON.stringify(polja)); } catch(e){}
}
function obnoviKrizanko() {
  try {
    const shrani = storage.getItem(krizankaKey);
    if (!shrani) return;
    const polja = JSON.parse(shrani);
    for (const p of polja) {
      const inp = document.querySelector(`input[data-x='${p.x}'][data-y='${p.y}']`);
      if (inp) inp.value = p.val;
    }
  } catch(e){}
}

/* ====== Povleƒçno (draggable) za kartico in gumb (shrani po datumu) ====== */
(function(){
  function makeDraggable(el, {handle=null, storageKey}) {
    if (!el) return;
    let startX=0,startY=0, elX=0,elY=0, dragging=false;
    const h = handle || el;

    // obnovi pozicijo
    try {
      const saved = JSON.parse(localStorage.getItem(storageKey) || 'null');
      if (saved && typeof saved.x==='number' && typeof saved.y==='number') {
        el.style.left = saved.x + 'px';
        el.style.top  = saved.y + 'px';
        el.style.right = 'auto';
      }
    } catch(_) {}

    const onDown = (e) => {
      dragging = true;
      el.classList.add('dragging');
      const rect = el.getBoundingClientRect();
      elX = rect.left; elY = rect.top;
      startX = (e.touches?.[0]?.clientX ?? e.clientX);
      startY = (e.touches?.[0]?.clientY ?? e.clientY);
      el.style.left = rect.left + 'px';
      el.style.top  = rect.top  + 'px';
      el.style.right = 'auto';
      window.addEventListener('pointermove', onMove, {passive:false});
      window.addEventListener('pointerup', onUp, {once:true});
      window.addEventListener('pointercancel', onUp, {once:true});
      e.preventDefault();
    };
    const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
    const onMove = (e) => {
      if (!dragging) return;
      const cx = (e.touches?.[0]?.clientX ?? e.clientX);
      const cy = (e.touches?.[0]?.clientY ?? e.clientY);
      let nx = elX + (cx - startX);
      let ny = elY + (cy - startY);
      const maxX = window.innerWidth  - el.offsetWidth  - 4;
      const maxY = window.innerHeight - el.offsetHeight - 4;
      nx = clamp(nx, 4, Math.max(4, maxX));
      ny = clamp(ny, 56, Math.max(56, maxY)); // pod navbar
      el.style.left = nx + 'px';
      el.style.top  = ny + 'px';
      e.preventDefault();
    };
    const onUp = () => {
      dragging = false;
      el.classList.remove('dragging');
      const rect = el.getBoundingClientRect();
      try { localStorage.setItem(storageKey, JSON.stringify({x:Math.round(rect.left), y:Math.round(rect.top)})); } catch(_){}
      window.removeEventListener('pointermove', onMove);
    };

    h.style.touchAction = 'none';
    h.addEventListener('pointerdown', onDown);
    window.addEventListener('resize', () => {
      const rect = el.getBoundingClientRect();
      const nx = Math.min(rect.left, window.innerWidth - el.offsetWidth - 4);
      const ny = Math.min(rect.top,  window.innerHeight - el.offsetHeight - 4);
      el.style.left = Math.max(4, nx) + 'px';
      el.style.top  = Math.max(56, ny) + 'px';
    });
  }

  window.addEventListener('DOMContentLoaded', () => {
    makeDraggable(document.getElementById('opisKartica'), {handle: document.getElementById('karticaHandle'), storageKey: `pos-kartica-${PUZZLE_ID}`});
    makeDraggable(document.getElementById('floatSmerBtn'), {storageKey: `pos-smerbtn-${PUZZLE_ID}`});
  });
})();

/* ====== Tvoja mre≈æa / podatki iz backenda ====== */
document.addEventListener('DOMContentLoaded', function () {
  const grid = document.getElementById('grid');
  const width = {{ podatki.sirina }};
  const height = {{ podatki.visina }};
  const crna_polja = {{ podatki.crna_polja | tojson }};
  const gesla_opisi = {{ podatki.gesla_opisi | tojson }};

  grid.style.gridTemplateColumns = `repeat(${width}, 40px)`;

  // zgradi mre≈æo
  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const cell = document.createElement('div');
      cell.classList.add('cell');

      if (crna_polja.some(p => p[0] === x && p[1] === y)) {
        cell.classList.add('black');
      } else {
        const input = document.createElement('input');
        input.setAttribute('maxlength', '1');
        input.dataset.x = x; input.dataset.y = y;
        cell.appendChild(input);

        const geslo = gesla_opisi.find(g => g.x === x && g.y === y);
        if (geslo && geslo.stevilka && geslo.stevilka !== '?') {
          const numberDiv = document.createElement('div');
          numberDiv.classList.add('cell-number');
          numberDiv.textContent = geslo.stevilka;
          cell.appendChild(numberDiv);
        }

        input.addEventListener('input', () => {
          if (input.value) input.value = input.value.toUpperCase();
          preveriCelotnoGeslo(input);
          if (input.value) premakniNaprej(input);
          shraniKrizanko();
        });
        input.addEventListener('click', () => { prikaziOpis(x, y); });
      }
      grid.appendChild(cell);
    }
  }

  // obnovi stanje za ta datum
  obnoviKrizanko();

  // ====== UI funkcije ======
  window.zamenjajSmer = function () {
    trenutnaSmer = (trenutnaSmer === 'across') ? 'down' : 'across';
    if (aktivniX !== null && aktivniY !== null) prikaziOpis(aktivniX, aktivniY);
  };

  window.preklopiKartico = function () {
    const k = document.getElementById('opisKartica');
    k.style.display = (k.style.display === 'none' || !k.style.display) ? 'block' : 'none';
  };

  function premakniNaprej(input) {
    let x = +input.dataset.x, y = +input.dataset.y;
    while (true) {
      x = (trenutnaSmer === 'across') ? x + 1 : x;
      y = (trenutnaSmer === 'down')  ? y + 1 : y;
      const next = document.querySelector(`input[data-x='${x}'][data-y='${y}']`);
      if (!next) break;
      if (!next.classList.contains('correct')) { next.focus(); break; }
    }
  }

  window.prikaziOpis = function (x, y) {
    aktivniX = x; aktivniY = y;
    const kartica = document.getElementById('opisKartica');
    kartica.style.display = "block";
    document.querySelectorAll('.cell').forEach(c => c.classList.remove('highlight'));

    const geslo = gesla_opisi.find(g =>
      g.smer === trenutnaSmer &&
      ((g.smer === 'across' && g.y === y && x >= g.x && x < g.x + g.dolzina) ||
       (g.smer === 'down'  && g.x === x && y >= g.y && y < g.y + g.dolzina))
    );

    const opisPolje = document.getElementById('karticaOpis');
    const slikaImg  = document.getElementById('karticaSlika');

    if (geslo) {
      for (let i = 0; i < geslo.dolzina; i++) {
        const tx = geslo.smer === 'across' ? geslo.x + i : geslo.x;
        const ty = geslo.smer === 'down'  ? geslo.y + i : geslo.y;
        const inp = document.querySelector(`input[data-x='${tx}'][data-y='${ty}']`);
        if (inp) inp.parentElement.classList.add('highlight');
      }

      const opisZaPrikaz = `${geslo.stevilka}. ${geslo.opis}`;
      opisPolje.textContent = opisZaPrikaz;

      // Pametno poi≈°ƒçi sliko (jpg, png, webp)
      const rezultat = normalizirajNaziv(geslo.opis);
      const koncnice = ['jpg','png','webp'];
      (function nastaviSliko(i){
        if (i >= koncnice.length) { slikaImg.src = ""; return; }
        const pot = `/static/Images/${rezultat}.${koncnice[i]}`;
        slikaImg.src = pot;
        slikaImg.onerror = () => nastaviSliko(i+1);
      })(0);
    } else {
      opisPolje.textContent = 'Klikni na polje za prikaz opisa';
      slikaImg.src = "";
    }
  };

  function preveriCelotnoGeslo(input) {
    const x = +input.dataset.x, y = +input.dataset.y;
    const geslo = gesla_opisi.find(g =>
      (g.smer === 'across' && g.y === y && x >= g.x && x < g.x + g.dolzina) ||
      (g.smer === 'down'  && g.x === x && y >= g.y && y < g.y + g.dolzina)
    );
    if (!geslo) return;

    const polja = [];
    for (let i = 0; i < geslo.dolzina; i++) {
      const tx = geslo.smer === 'across' ? geslo.x + i : geslo.x;
      const ty = geslo.smer === 'down'  ? geslo.y + i : geslo.y;
      const inp = document.querySelector(`input[data-x='${tx}'][data-y='${ty}']`);
      if (inp) polja.push(inp);
    }

    const resitev = geslo.solution.replace(/[^A-Zƒå≈†≈Ω]/gi, '').toUpperCase();
    for (let i = 0; i < polja.length; i++) {
      const inp = polja[i];
      const znak = (inp.value || '').toUpperCase();
      inp.classList.remove('correct','incorrect');
      if (!znak.match(/[A-Zƒå≈†≈Ω]/)) continue;
      const idx = (geslo.smer === 'across') ? (+inp.dataset.x - geslo.x) : (+inp.dataset.y - geslo.y);
      if (znak === resitev[idx]) inp.classList.add('correct'); else inp.classList.add('incorrect');
    }
  }
});
</script>
{% endblock %}
