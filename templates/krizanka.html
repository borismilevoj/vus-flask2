{% extends "base.html" %}
{% block title %}Križanka | VUS{% endblock %}
{% block content %}
<div style="display: flex; justify-content: center; align-items: flex-start; gap: 40px; flex-wrap: wrap; margin-top: 20px;">
  <div id="grid"></div>
  <div class="opis-box">
    <div class="opis" id="opisPolje">Klikni na polje v križanki za prikaz opisa.</div>
  </div>
</div>
<div id="uspeh" style="display:none; text-align:center; margin-top:20px; font-size:1.5rem; font-weight:bold; color:green; animation: fadeIn 2s ease-in-out;">
  ✨ ČESTITAMO, USPEŠNO STE REŠILI KRIŽANKO! ✨
</div>
{% endblock %}

{% block styles %}
<style>
#grid {
  display: grid;
  grid-template-columns: repeat({{ podatki.sirina }}, 30px);
  grid-auto-rows: 30px;
  gap: 2px;
  margin-top: 20px;
}
.cell {
  position: relative;
  width: 30px;
  height: 30px;
  border: 1px solid #999;
  box-sizing: border-box;
}
.cell input {
  width: 100%;
  height: 100%;
  font-size: 16px;
  text-align: center;
  text-transform: uppercase;
  border: none;
  outline: none;
}
.cell.black {
  background-color: black;
}
.cell-number {
  position: absolute;
  top: 0;
  left: 0;
  font-size: 10px;
  color: blue;
  z-index: 2;
}
.cell.highlight {
  border: 2px solid red;
}
.opis-box {
  width: 320px;
  min-height: 150px;
  border: 1px solid #ccc;
  padding: 15px;
  background-color: #f8f8f8;
  font-size: 1rem;
}
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
</style>
{% endblock %}

{% block scripts %}
<script>
const width = {{ podatki.sirina }};
const height = {{ podatki.visina }};
const crna_polja = {{ podatki.crna_polja | tojson }};
const gesla_opisi = {{ podatki.gesla_opisi | tojson }};
let trenutnaSmer = 'across';

const grid = document.getElementById('grid');

for (let y = 0; y < height; y++) {
  for (let x = 0; x < width; x++) {
    const cell = document.createElement('div');
    cell.classList.add('cell');

    if (crna_polja.some(p => p[0] === x && p[1] === y)) {
      cell.classList.add('black');
    } else {
      const input = document.createElement('input');
      input.setAttribute('maxlength', '1');
      input.dataset.x = x;
      input.dataset.y = y;

      input.addEventListener('input', () => {
        preveriCrko(input);
        premakniNaprej(input);
      });

      input.addEventListener('click', () => {
        prikaziOpis(x, y);
        oznaciGeslo(x, y);
      });

      input.addEventListener('dblclick', () => {
        trenutnaSmer = trenutnaSmer === 'across' ? 'down' : 'across';
        prikaziOpis(x, y);
        oznaciGeslo(x, y);
      });

      cell.appendChild(input);

      const geslo = gesla_opisi.find(g => g.x === x && g.y === y);
      if (geslo && geslo.stevilka !== '?') {
        const numberDiv = document.createElement('div');
        numberDiv.classList.add('cell-number');
        numberDiv.textContent = geslo.stevilka;
        cell.appendChild(numberDiv);
      }
    }

    grid.appendChild(cell);
  }
}

document.addEventListener('keydown', function (e) {
  const active = document.activeElement;
  if (!active || active.tagName !== 'INPUT') return;

  if (e.key === 'Tab' && e.shiftKey) {
    e.preventDefault();
    premakniNazaj(active);
  }

  if ((e.key === 'Enter') || (e.key === 'Tab' && !e.shiftKey)) {
    e.preventDefault();
    premakniNaprej(active);
  }
});

function oznaciGeslo(x, y) {
  document.querySelectorAll('.cell').forEach(c => c.classList.remove('highlight'));

  gesla_opisi.forEach(g => {
    if ((trenutnaSmer === 'across' && g.smer === 'across' && g.y === y && x >= g.x && x < g.x + g.dolzina) ||
        (trenutnaSmer === 'down' && g.smer === 'down' && g.x === x && y >= g.y && y < g.y + g.dolzina)) {
      for (let i = 0; i < g.dolzina; i++) {
        const tx = g.smer === 'across' ? g.x + i : g.x;
        const ty = g.smer === 'down' ? g.y + i : g.y;
        const inp = document.querySelector(`input[data-x='${tx}'][data-y='${ty}']`);
        if (inp) inp.parentElement.classList.add('highlight');
      }
    }
  });
}

function premakniNaprej(input) {
  let x = +input.dataset.x;
  let y = +input.dataset.y;
  while (true) {
    x = trenutnaSmer === 'across' ? x + 1 : x;
    y = trenutnaSmer === 'down' ? y + 1 : y;
    const nextInput = document.querySelector(`.cell input[data-x='${x}'][data-y='${y}']`);
    if (!nextInput) break;
    if (!nextInput.classList.contains('correct')) {
      nextInput.focus();
      break;
    }
  }
}

function premakniNazaj(input) {
  let x = +input.dataset.x;
  let y = +input.dataset.y;
  while (true) {
    x = trenutnaSmer === 'across' ? x - 1 : x;
    y = trenutnaSmer === 'down' ? y - 1 : y;
    const prevInput = document.querySelector(`.cell input[data-x='${x}'][data-y='${y}']`);
    if (!prevInput) break;
    prevInput.focus();
    break;
  }
}

function preveriCrko(input) {
  const x = +input.dataset.x;
  const y = +input.dataset.y;
  const geslo = gesla_opisi.find(g =>
    (g.smer === 'across' && g.y === y && x >= g.x && x < g.x + g.dolzina) ||
    (g.smer === 'down' && g.x === x && y >= g.y && y < g.y + g.dolzina)
  );
  if (!geslo) return;
  const index = geslo.smer === 'across' ? x - geslo.x : y - geslo.y;
  const pravilna = geslo.solution[index];
  const vnos = input.value.toUpperCase();
  input.classList.remove('correct', 'incorrect');
  if (vnos === '') return;
  if (vnos === pravilna) {
    input.classList.add('correct');
    input.value = pravilna;
    preveriUspeh();
  } else {
    input.classList.add('incorrect');
  }
}

function preveriUspeh() {
  const inputs = document.querySelectorAll('.cell input');
  for (let i of inputs) if (!i.classList.contains('correct')) return;
  document.getElementById('uspeh').style.display = 'block';
}

function prikaziOpis(x, y) {
  const opisPolje = document.getElementById('opisPolje');
  const geslo = gesla_opisi.find(g =>
    (trenutnaSmer === 'across' && g.y === y && x >= g.x && x < g.x + g.dolzina) ||
    (trenutnaSmer === 'down' && g.x === x && y >= g.y && y < g.y + g.dolzina)
  );
  opisPolje.textContent = geslo ? `${geslo.stevilka}. ${geslo.opis}` : 'Ni opisa.';
}
</script>
{% endblock %}
