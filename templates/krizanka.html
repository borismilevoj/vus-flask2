{% extends "base.html" %}
{% block title %}Kri≈æanka | VUS{% endblock %}

{% block content %}
<style>
  #wrap { display: grid; grid-template-columns: 1fr 340px; gap: 16px; }
  #grid { display: grid; gap: 2px; }
  .cell { position: relative; width: 40px; height: 40px; background:#fff; border:1px solid #ddd; }
  .cell.black { background:#333; border-color:#333; }
  .cell input { width:100%; height:100%; border:none; text-align:center; font-size:20px; text-transform:uppercase; }
  .cell-number { position:absolute; top:2px; left:4px; font-size:10px; color:#666; }
  .highlight { outline:2px solid #3b82f6; outline-offset:-2px; }
  .correct { background:#e6ffe6 !important; }
  .incorrect { background:#ffe6e6 !important; }

  /* Plavajoƒça (draggable) kartica */
  #opisKartica{
    position:fixed; top:90px; right:16px;
    width:min(380px, 90vw); max-height:70vh; overflow:auto;
    z-index:9999; background:#fafafa; border:1px solid #ddd; border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.12); touch-action:none; display:none;
  }
  #opisKartica.dragging{ cursor:grabbing; }
  #karticaHandle{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:6px 10px; background:#eee; border-bottom:1px solid #ddd;
    font-weight:600; user-select:none; cursor:grab;
    border-top-left-radius:12px; border-top-right-radius:12px;
  }
  #karticaBody{ padding:10px; }
  #karticaOpis{ font-size:16px; line-height:1.35; }
  #karticaSlika{ max-width:100%; height:auto; border:1px solid #eee; border-radius:8px; }

  /* Plavajoƒçi gumb za smer */
  #floatSmerBtn{
    position:fixed; left:16px; bottom:16px; z-index:10000;
    width:56px; height:56px; border-radius:50%; box-shadow:0 8px 24px rgba(0,0,0,.18); touch-action:none;
  }
</style>

<div class="d-flex justify-content-end mb-3">
  <a class="btn btn-secondary" href="/krizanka/arhiv">üìÇ Arhiv kri≈æank</a>
  <button class="btn btn-outline-secondary ms-2" type="button" onclick="preklopiKartico()">üõà Opis</button>
</div>

<div id="wrap">
  <div id="grid" aria-label="Mre≈æa kri≈æanke"></div>
</div>

<!-- Plavajoƒça kartica -->
<aside id="opisKartica">
  <div id="karticaHandle">
    <span>‚ò∞ Opis</span>
    <button class="btn btn-sm btn-light" type="button" onclick="preklopiKartico()">‚úï</button>
  </div>
  <div id="karticaBody">
    <div id="karticaOpis">Klikni na polje za prikaz opisa</div>
    <img id="karticaSlika" alt="Slika k opisu (ƒçe obstaja)">
  </div>
</aside>

<!-- Plavajoƒçi gumb za spremembo smeri -->
<button id="floatSmerBtn" class="btn btn-primary" title="Spremeni smer" onclick="zamenjajSmer()">‚ÜïÔ∏è</button>
{% endblock %}

{% block scripts %}
<script>
/* ===== Helperji ===== */
function normalizirajNaziv(opis){
  return (opis||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[-‚Äì‚Äî‚àí‚Ä†().,]/g,'')
    .toLowerCase().replace(/[^a-z0-9\s]/g,'')
    .trim().split(/\s+/).slice(0,15).join('_');
}

let trenutnaSmer='across';
let aktivniX=null, aktivniY=null;

/* ===== ID po datumu (za shranjevanje stanja/pozicij) ===== */
const datumFromServer="{{ datum|default('', true) }}";
const datumFromUrl=(location.pathname.match(/\/krizanka\/(\d{4}-\d{2}-\d{2})/)||[,''])[1];
const PUZZLE_ID=datumFromServer||datumFromUrl||new Date().toISOString().slice(0,10);

/* ===== Shranjevanje vnosa mre≈æe ===== */
const storage=window.localStorage;
const krizankaKey=`krizanka-rezultat-${PUZZLE_ID}`;
function shraniKrizanko(){
  const polja=Array.from(document.querySelectorAll("#grid input"))
    .map(inp=>({x:inp.dataset.x,y:inp.dataset.y,val:inp.value}));
  try{ storage.setItem(krizankaKey, JSON.stringify(polja)); }catch(e){}
}
function obnoviKrizanko(){
  try{
    const s=storage.getItem(krizankaKey); if(!s) return;
    JSON.parse(s).forEach(p=>{
      const inp=document.querySelector(`input[data-x='${p.x}'][data-y='${p.y}']`);
      if(inp) inp.value=p.val;
    });
  }catch(e){}
}

/* ===== Draggable (kartica & gumb) ===== */
(function(){
  function makeDraggable(el,{handle=null,storageKey}={}){
    if(!el) return;
    let startX=0,startY=0,elX=0,elY=0,drag=false;
    const h=handle||el;
    // obnovi
    try{ const saved=JSON.parse(localStorage.getItem(storageKey)||'null');
      if(saved){ el.style.left=saved.x+'px'; el.style.top=saved.y+'px'; el.style.right='auto'; }
    }catch(_){}
    const onDown=e=>{
      drag=true; el.classList.add('dragging');
      const r=el.getBoundingClientRect();
      elX=r.left; elY=r.top;
      startX=(e.touches?.[0]?.clientX ?? e.clientX);
      startY=(e.touches?.[0]?.clientY ?? e.clientY);
      el.style.left=r.left+'px'; el.style.top=r.top+'px'; el.style.right='auto';
      window.addEventListener('pointermove', onMove, {passive:false});
      window.addEventListener('pointerup', onUp, {once:true});
      window.addEventListener('pointercancel', onUp, {once:true});
      e.preventDefault();
    };
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const onMove=e=>{
      if(!drag) return;
      const cx=(e.touches?.[0]?.clientX ?? e.clientX);
      const cy=(e.touches?.[0]?.clientY ?? e.clientY);
      let nx=elX+(cx-startX), ny=elY+(cy-startY);
      const maxX=window.innerWidth-el.offsetWidth-4;
      const maxY=window.innerHeight-el.offsetHeight-4;
      nx=clamp(nx,4,Math.max(4,maxX)); ny=clamp(ny,56,Math.max(56,maxY));
      el.style.left=nx+'px'; el.style.top=ny+'px'; e.preventDefault();
    };
    const onUp=()=>{
      drag=false; el.classList.remove('dragging');
      const r=el.getBoundingClientRect();
      try{ localStorage.setItem(storageKey, JSON.stringify({x:Math.round(r.left), y:Math.round(r.top)})); }catch(_){}
      window.removeEventListener('pointermove', onMove);
    };
    h.style.touchAction='none'; h.addEventListener('pointerdown', onDown);
    window.addEventListener('resize', ()=>{
      const r=el.getBoundingClientRect();
      const nx=Math.min(r.left, window.innerWidth-el.offsetWidth-4);
      const ny=Math.min(r.top,  window.innerHeight-el.offsetHeight-4);
      el.style.left=Math.max(4,nx)+'px'; el.style.top=Math.max(56,ny)+'px';
    });
  }
  window.addEventListener('DOMContentLoaded', ()=>{
    makeDraggable(document.getElementById('opisKartica'), {handle:document.getElementById('karticaHandle'), storageKey:`pos-kartica-${PUZZLE_ID}`});
    makeDraggable(document.getElementById('floatSmerBtn'), {storageKey:`pos-smerbtn-${PUZZLE_ID}`});
  });
})();

/* ===== Mre≈æa iz backenda ===== */
document.addEventListener('DOMContentLoaded', function(){
  const grid=document.getElementById('grid');
  const width = {{ podatki.sirina }};
  const height= {{ podatki.visina }};
  const crna_polja = {{ podatki.crna_polja | tojson }};
  const gesla_opisi= {{ podatki.gesla_opisi | tojson }};

  // GA open (ƒçe je na voljo)
  try{
    if(typeof gtagEvent==='function'){ gtagEvent('crossword_open', {date:'{{ datum|default('', true) }}'}); }
    else if(typeof gtag==='function'){ gtag('event','crossword_open',{date:'{{ datum|default('', true) }}'}); }
  }catch(_){}

  grid.style.gridTemplateColumns=`repeat(${width}, 40px)`;

  for(let y=0;y<height;y++){
    for(let x=0;x<width;x++){
      const cell=document.createElement('div'); cell.classList.add('cell');
      if(crna_polja.some(p=>p[0]===x && p[1]===y)){ cell.classList.add('black'); }
      else{
        const input=document.createElement('input');
        input.maxLength=1; input.dataset.x=x; input.dataset.y=y; cell.appendChild(input);

        const g=gesla_opisi.find(t=>t.x===x && t.y===y);
        if(g && g.stevilka && g.stevilka!=='?'){
          const num=document.createElement('div'); num.classList.add('cell-number'); num.textContent=g.stevilka; cell.appendChild(num);
        }

        input.addEventListener('input', ()=>{
          if(input.value) input.value=input.value.toUpperCase();
          preveriCelotnoGeslo(input);
          checkSolved();
          if(input.value) premakniNaprej(input);
          shraniKrizanko();
        });
        input.addEventListener('click', ()=>{ prikaziOpis(x,y); });
      }
      grid.appendChild(cell);
    }
  }

  obnoviKrizanko();
  checkSolved();
  window.zamenjajSmer=function(){
    trenutnaSmer=(trenutnaSmer==='across')?'down':'across';
    if(aktivniX!==null && aktivniY!==null) prikaziOpis(aktivniX,aktivniY);
  };

  window.preklopiKartico=function(){
    const k=document.getElementById('opisKartica');
    k.style.display=(k.style.display==='none'||!k.style.display)?'block':'none';
  };

  function premakniNaprej(input){
    let x=+input.dataset.x, y=+input.dataset.y;
    while(true){
      x=(trenutnaSmer==='across')?x+1:x;
      y=(trenutnaSmer==='down') ?y+1:y;
      const next=document.querySelector(`input[data-x='${x}'][data-y='${y}']`);
      if(!next) break;
      if(!next.classList.contains('correct')){ next.focus(); break; }
    }
  }

  window.prikaziOpis = function (x, y) {
    aktivniX = x; aktivniY = y;
    const kartica = document.getElementById('opisKartica');
    kartica.style.display = "block";
    document.querySelectorAll('.cell').forEach(c => c.classList.remove('highlight'));

    const g = gesla_opisi.find(t =>
      t.smer === trenutnaSmer &&
      ((t.smer === 'across' && t.y === y && x >= t.x && x < t.x + t.dolzina) ||
       (t.smer === 'down'  && t.x === x && y >= t.y && y < t.y + t.dolzina))
    );

    const opisPolje = document.getElementById('karticaOpis');
    const slikaImg  = document.getElementById('karticaSlika');

    if (g) {
      // highlight aktivnega gesla
      for (let i = 0; i < g.dolzina; i++) {
        const tx = (g.smer === 'across') ? g.x + i : g.x;
        const ty = (g.smer === 'down')  ? g.y + i : g.y;
        const inp = document.querySelector(`input[data-x='${tx}'][data-y='${ty}']`);
        if (inp) inp.parentElement.classList.add('highlight');
      }

      // opis
      opisPolje.textContent = `${g.stevilka}. ${g.opis}`;

      // --- SLIKA: najprej OPIS+RE≈†ITEV, potem fallback na samo OPIS ---
      const exti = ['jpg', 'png', 'webp'];
      const baseOpis = normalizirajNaziv(g.opis);
      const baseFull = g.solution ? `${baseOpis}_${normalizirajNaziv(g.solution)}` : null;

      function nalozi(indExt, faza) {
        // faza 0 = poskusi OPIS+RE≈†ITEV (ƒçe imamo solution), faza 1 = samo OPIS
        const base = (faza === 0 && baseFull) ? baseFull : baseOpis;
        if (indExt >= exti.length) {
          if (faza === 0 && baseFull) return nalozi(0, 1); // preklop na fallback
          slikaImg.src = ""; // niƒç ni na≈°el
          return;
        }
        const pot = `/static/Images/${base}.${exti[indExt]}`;
        slikaImg.src = pot;
        slikaImg.onerror = () => nalozi(indExt + 1, faza);
      }

      nalozi(0, 0);
    } else {
      opisPolje.textContent = 'Klikni na polje za prikaz opisa';
      slikaImg.src = "";
    }
  };

  // ‚úì konƒçana kri≈æanka = noben input ni prazen in ni rdeƒçih polj
  function checkSolved() {
    const inputs = document.querySelectorAll('#grid input');
    for (const inp of inputs) {
      if (!inp.value) return false;
      if (inp.classList.contains('incorrect')) return false;
    }
    if (!window.__cwDoneOnce) {
      window.__cwDoneOnce = true;
      try { trackCrosswordComplete(); } catch (_) {}
    }
    return true;
  }

  function preveriCelotnoGeslo(input){
    const x=+input.dataset.x, y=+input.dataset.y;
    const g=gesla_opisi.find(t =>
      (t.smer==='across' && t.y===y && x>=t.x && x<t.x+t.dolzina) ||
      (t.smer==='down'  && t.x===x && y>=t.y && y<t.y+t.dolzina)
    );
    if(!g) return;

    const polja=[];
    for(let i=0;i<g.dolzina;i++){
      const tx=(g.smer==='across')? g.x+i : g.x;
      const ty=(g.smer==='down') ? g.y+i : g.y;
      const inp=document.querySelector(`input[data-x='${tx}'][data-y='${ty}']`);
      if(inp) polja.push(inp);
    }

    const res=g.solution.replace(/[^A-Zƒå≈†≈Ω]/gi,'').toUpperCase();
    for(let i=0;i<polja.length;i++){
      const inp=polja[i], znak=(inp.value||'').toUpperCase();
      inp.classList.remove('correct','incorrect');
      if(!znak.match(/[A-Zƒå≈†≈Ω]/)) continue;
      const idx=(g.smer==='across')? (+inp.dataset.x-g.x) : (+inp.dataset.y-g.y);
      if(znak===res[idx]) inp.classList.add('correct'); else inp.classList.add('incorrect');
    }

    if(polja.length && polja.every((inp,i)=>{
      const idx=(g.smer==='across')? (+inp.dataset.x-g.x) : (+inp.dataset.y-g.y);
      return (inp.value||'').toUpperCase()===res[idx];
    })){
      // po ≈æelji: tu lahko preveri≈° celotno mre≈æo in spro≈æi≈° trackCrosswordComplete()
    }
  }
});

/* Enkraten GA, ko zakljuƒçi≈° (pokliƒçi trackCrosswordComplete() v tvoji ‚ÄúƒåESTITAMO‚Äù logiki) */
(function(){
  const key=`cw_done_{{ datum|default('', true) }}`;
  window.trackCrosswordComplete=function(){
    try{
      if(localStorage.getItem(key)) return;
      localStorage.setItem(key,'1');
      const d='{{ datum|default('', true) }}';
      if(typeof gtagEvent==='function'){ gtagEvent('crossword_complete',{date:d}); }
      else if(typeof gtag==='function'){ gtag('event','crossword_complete',{date:d}); }
    }catch(_){}
  };
})();
</script>

<!-- CC assets: dinamiƒçni URL-ji pridejo iz view-a -->
<link rel="preload" href="{{ xml_url }}" as="fetch" type="application/xml">
<script defer src="{{ js_url }}"></script>
{% endblock %}
