{% extends "base.html" %}
{% block title %}Administracija VUS{% endblock %}

{% block head %}
<style>
  .card-title { font-weight: 600; }
  .form-text { color: #6c757d; }
  .btn-dark { background:#1f2937; border-color:#1f2937; }
  .btn-dark:hover { filter: brightness(1.08); }
  .card.h-100 { height: 100%; }

  /* izolacija rezultatov, da nič ne prekriva */
  #rezCard { position: relative; z-index: 5; clear: both; }
  #rezCard .table-responsive { overflow: visible; }

  /* lepši table vibes */
  #rezCard thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
  #rezCard tbody tr:nth-child(odd) { background: #fafafa; }
  #rezCard tbody tr:hover { background: #f3f7ff; }
  #rezCard .btn { padding: .25rem .5rem; }
  mark { padding: 0 .15rem; border-radius: .2rem; }

  /* malo tesnejša tabela na večjih zaslonih */
  @media (min-width: 992px) {
    .card .form-control, .card .btn { font-size: 0.95rem; }
    table.table td, table.table th { vertical-align: top; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">Administracija VUS</h1>
    <div class="text-muted small">
      Gesel v bazi: <span id="stevecHome">—</span>
    </div>
  </div>

  <div class="row g-3">
    <!-- LEVA: PREVERI + DODAJ -->
    <div class="col-lg-4">
      <!-- PREVERI -->
      <div class="card mb-3">
        <div class="card-body">
          <h2 class="card-title h6 mb-3">Preveri geslo</h2>
          <div class="mb-2">
            <label for="inpPreveri" class="form-label">Geslo</label>
            <input type="text" class="form-control" id="inpPreveri" placeholder="npr. ZAGORJE OB SAVI">
            <div class="form-text">Preveri, če geslo že obstaja v bazi. Enter ali gumb spodaj.</div>
          </div>
          <div class="d-flex align-items-center">
            <button class="btn btn-primary" id="btnPreveri">PREVERI</button>
            <span class="ms-3 small" id="preveriMsg"></span>
          </div>
        </div>
      </div>

      <!-- DODAJ -->
      <div class="card">
        <div class="card-body">
          <h2 class="card-title h6 mb-3">Dodaj geslo</h2>
          <div class="mb-2">
            <label for="inpNovo" class="form-label">Geslo</label>
            <input type="text" class="form-control" id="inpNovo" placeholder="novo geslo">
          </div>
          <div class="mb-2">
            <label for="inpOpis" class="form-label">Opis</label>
            <textarea class="form-control" id="inpOpis" rows="4" placeholder="opis gesla"></textarea>
            <div class="form-text">Po dodajanju se opis počisti, geslo ostane – da takoj vidiš zadetek.</div>
          </div>
          <div class="d-flex align-items-center">
            <button class="btn btn-success" id="btnDodaj">DODAJ</button>
            <span class="ms-3 small" id="dodajMsg"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- DESNA: REZULTATI -->
    <div class="col-lg-8">
      <div class="card h-100" id="rezCard">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <div class="d-flex align-items-center gap-3">
              <h2 class="card-title h6 m-0">Rezultati</h2>
              <div class="form-check m-0">
                <input class="form-check-input" type="checkbox" id="cbExact" checked>
                <label class="form-check-label" for="cbExact">Natančno ujemanje</label>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-outline-secondary btn-sm" id="btnPonastavi" title="Počisti rezultate">PONASTAVI</button>
              <div class="small text-muted" id="rezMsg"></div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th style="width: 1%">ID</th>
                  <th style="width: 20%">Geslo</th>
                  <th>Opis</th>
                  <th class="text-end" style="width: 1%">Akcije</th>
                </tr>
              </thead>
              <tbody id="rezBody">
                <!-- tukaj JS riše vrstice -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /row -->
</div><!-- /container -->
{% endblock %}

{% block scripts %}
{% raw %}
<script>
(() => {
  // ===== helpers =====
  const $ = (x) => document.getElementById(x);
  const esc = (s) => { const d=document.createElement('div'); d.innerText=s ?? ''; return d.innerHTML; };

  async function httpGet(url) {
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  }
  async function httpPost(url, data) {
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(data || {}),
      cache: 'no-store'
    });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  }
  async function trySequence(steps) {
    const errors = [];
    for (const step of steps) {
      const { method, url, payload } = step;
      try {
        const data = method === 'POST' ? await httpPost(url, payload) : await httpGet(url);
        return { url, method, data };
      } catch (e) {
        errors.push(`• ${method} ${url}: ${e.message}`);
      }
    }
    throw new Error(`Noben endpoint ni uspel:\n${errors.join('\n')}`);
  }
  function setText(el, txt, cls) {
    if (!el) return;
    el.textContent = txt;
    el.classList.remove('text-success','text-danger','text-muted');
    if (cls) el.classList.add(cls);
  }

  // ===== sort utils =====
  function normalizeStr(s) {
    return (s ?? '')
      .toString()
      .trim()
      .toLowerCase()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu, '');
  }
  function afterLastHyphen(s) {
    const t = (s ?? '').toString();
    const i = t.lastIndexOf('-');
    return i >= 0 ? t.slice(i + 1).trim() : t.trim();
  }
  function cmp(a, b) {
    const aG = a.geslo ?? a.GESLO ?? '';
    const bG = b.geslo ?? b.GESLO ?? '';
    const aHasHyphen = /-/.test(aG);
    const bHasHyphen = /-/.test(bG);
    if (aHasHyphen !== bHasHyphen) return aHasHyphen ? -1 : 1;

    if (aHasHyphen && bHasHyphen) {
      const aKey = normalizeStr(afterLastHyphen(a.opis ?? a.OPIS ?? aG));
      const bKey = normalizeStr(afterLastHyphen(b.opis ?? b.OPIS ?? bG));
      if (aKey !== bKey) return aKey.localeCompare(bKey, 'sl', { sensitivity:'base' });
    }

    const aN = normalizeStr(aG);
    const bN = normalizeStr(bG);
    if (aN !== bN) return aN.localeCompare(bN, 'sl', { sensitivity:'base' });

    const aId = +((a.id ?? a.ID ?? '') || 0);
    const bId = +((b.id ?? b.ID ?? '') || 0);
    return aId - bId;
  }

  // ===== DOM refs =====
  const inpPreveri = $('inpPreveri');
  const btnPreveri = $('btnPreveri');
  const preveriMsg = $('preveriMsg');

  const inpNovo  = $('inpNovo');
  const inpOpis  = $('inpOpis');
  const btnDodaj = $('btnDodaj');
  const dodajMsg = $('dodajMsg');

  const rezBody  = $('rezBody');
  const rezMsg   = $('rezMsg');

  const cbExact = $('cbExact');
  const btnPonastavi = $('btnPonastavi');

  // ===== highlight helper (3A) =====
  function highlight(text, query) {
    const t = (text ?? '').toString();
    const q = (query ?? '').toString().trim();
    if (!q) return esc(t);
    const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    return esc(t).replace(re, (m) => `<mark>${esc(m)}</mark>`);
  }

  // ===== rendering z vgrajenim sortom + highlight (3C) =====
  function renderResults(arr) {
    if (!rezBody) return;
    const sorted = (arr || []).slice().sort(cmp);
    const qMark = (inpPreveri?.value || inpNovo?.value || '').trim();

    const rows = sorted.map(r => {
      const id = esc(r.id ?? r.ID ?? '');
      const g  = r.geslo ?? r.GESLO ?? '';
      const o  = r.opis  ?? r.OPIS  ?? '';
      return `<tr data-id="${id}">
        <td class="text-nowrap">${id}</td>
        <td class="fw-semibold">${highlight(g, qMark)}</td>
        <td class="opis-cell">${highlight(o, qMark)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-action="uredi">UREDI</button>
          <button class="btn btn-sm btn-outline-danger ms-1" data-action="brisi">BRIŠI</button>
        </td>
      </tr>`;
    }).join('');
    rezBody.innerHTML = rows;
    if (rezMsg) { rezMsg.textContent = `${sorted.length} zadetkov`; rezMsg.classList.add('text-muted'); }
  }

  // ===== exact fetch z možnostjo nenatančnega (3D) =====
  async function fetchExact(geslo, exactOnly = true) {
    const q = encodeURIComponent(geslo);
    const steps = [
      { method:'GET', url:`/preveri_geslo?t=${q}` },
      { method:'GET', url:`/admin/preveri?t=${q}` },
      { method:'GET', url:`/preveri?t=${q}` },
      { method:'POST', url:'/preveri_geslo', payload:{ t:geslo, geslo } },
      { method:'POST', url:'/admin/preveri', payload:{ t:geslo, geslo } },
      { method:'POST', url:'/preveri',      payload:{ t:geslo, geslo } },
    ];
    const { data } = await trySequence(steps);
    const results = data.results ?? data.zadetki ?? data.matches ?? data.items ?? [];
    if (!exactOnly) return results;

    const norm = (s) => (s ?? '').toString().trim();
    const exact = results.filter(r => norm(r.geslo ?? r.GESLO) === norm(geslo));
    return exact.length ? exact : results;
  }

  // ===== PREVERI (3E) =====

async function preveri() {
  const q = (inpPreveri?.value || '').trim();
  if (!q) return setText(preveriMsg, 'Vnesi geslo za preverjanje.', 'text-danger');
  setText(preveriMsg, 'Preverjam …', 'text-muted');

  try {
    const resp = await fetch(`/preveri_geslo?t=${encodeURIComponent(q)}`);
    const data = await resp.json();
    console.log('🟢 PODATKI IZ BACKENDA:', data);

    alert(`Prejeto ${data.count} rezultatov.`); // <- to boš VIDEL takoj v brskalniku
  } catch (e) {
    console.error('Napaka:', e);
    alert(`Napaka: ${e.message}`);
  }
}



  // ===== DODAJ (3F ostane – refresh + highlight že dela) =====
  async function dodaj() {
    const g = (inpNovo?.value || '').trim();
    const o = (inpOpis?.value || '').trim();
    if (!g) return setText(dodajMsg, 'Vnesi geslo.', 'text-danger');
    if (!o) return setText(dodajMsg, 'Vnesi opis.', 'text-danger');

    setText(dodajMsg, 'Dodajam …', 'text-muted');
    btnDodaj && (btnDodaj.disabled = true);
    try {
      const payload = { geslo: g, opis: o };
      const steps = [
        { method:'POST', url:'/dodaj_geslo', payload },
        { method:'POST', url:'/admin/dodaj', payload },
        { method:'POST', url:'/api/dodaj_geslo', payload },
      ];
      await trySequence(steps);

      const res = await fetchExact(g, true);
      renderResults(res);

      setText(dodajMsg, `✅ Dodano: "${g}"`, 'text-success');
      if (inpNovo) inpNovo.value = g;   // pusti geslo
      if (inpOpis) inpOpis.value = '';  // opis počisti
      refreshStevec();
    } catch (e) {
      console.error('DODAJ napaka:', e);
      setText(dodajMsg, `⚠ ${e.message || e}`, 'text-danger');
    } finally {
      btnDodaj && (btnDodaj.disabled = false);
    }
  }
  btnDodaj?.addEventListener('click', (ev) => { ev.preventDefault(); dodaj(); });

  // ===== UREDI inline =====
  async function shraniUrejanje(tr) {
    const id = tr.getAttribute('data-id');
    const ta = tr.querySelector('textarea');
    const novOpis = (ta?.value || '').trim();
    if (!id) return;

    const btns = tr.querySelectorAll('button'); btns.forEach(b => b.disabled = true);
    try {
      const payload = { id, opis: novOpis };
      const steps = [
        { method:'POST', url:'/uredi_geslo', payload },
        { method:'POST', url:'/admin/uredi', payload },
        { method:'POST', url:'/api/uredi_geslo', payload },
      ];
      await trySequence(steps);

      const cell = tr.querySelector('.opis-cell');
      if (cell) cell.innerHTML = esc(novOpis);
      tr.querySelector('[data-action="preklic"]')?.remove();
      tr.querySelector('[data-action="shrani"]')?.remove();
      const actions = tr.querySelector('td.text-end');
      if (actions) {
        actions.innerHTML =
          '<button class="btn btn-sm btn-outline-primary" data-action="uredi">UREDI</button>' +
          '<button class="btn btn-sm btn-outline-danger ms-1" data-action="brisi">BRIŠI</button>';
      }
    } catch (e) {
      alert('Napaka pri shranjevanju: ' + (e.message || e));
    } finally {
      btns.forEach(b => b.disabled = false);
    }
  }
  function zacniUrejanje(tr) {
    const cell = tr.querySelector('.opis-cell'); if (!cell) return;
    const stari = cell.textContent;
    cell.innerHTML = `<textarea class="form-control form-control-sm" rows="3">${esc(stari)}</textarea>`;
    const actions = tr.querySelector('td.text-end');
    if (actions) {
      actions.innerHTML =
        '<button class="btn btn-sm btn-success" data-action="shrani">SHRANI</button>' +
        '<button class="btn btn-sm btn-secondary ms-1" data-action="preklic">PREKLIČI</button>';
    }
  }
  function preklicUrejanja(tr) {
    const cell = tr.querySelector('.opis-cell'); if (!cell) return;
    const ta = tr.querySelector('textarea');
    const backup = ta ? ta.defaultValue : cell.textContent;
    cell.textContent = backup;
    const actions = tr.querySelector('td.text-end');
    if (actions) {
      actions.innerHTML =
        '<button class="btn btn-sm btn-outline-primary" data-action="uredi">UREDI</button>' +
        '<button class="btn btn-sm btn-outline-danger ms-1" data-action="brisi">BRIŠI</button>';
    }
  }

  // ===== BRIŠI =====
  async function brisi(tr) {
    const id = tr.getAttribute('data-id'); if (!id) return;
    if (!confirm('Res izbrišem zapis #' + id + '?')) return;

    const btns = tr.querySelectorAll('button'); btns.forEach(b => b.disabled = true);
    try {
      const payload = { id };
      const steps = [
        { method:'POST', url:'/brisi_geslo', payload },
        { method:'POST', url:'/admin/brisi', payload },
        { method:'POST', url:'/api/brisi_geslo', payload },
      ];
      await trySequence(steps);
      tr.remove();
      if (rezMsg) rezMsg.textContent = `${document.querySelectorAll('#rezBody tr').length} zadetkov`;
      refreshStevec();
    } catch (e) {
      alert('Napaka pri brisanju: ' + (e.message || e));
      btns.forEach(b => b.disabled = false);
    }
  }

  // ===== delegacija klikov =====
  $('rezBody')?.addEventListener('click', (ev) => {
    const btn = ev.target.closest('button[data-action]');
    if (!btn) return;
    const tr = btn.closest('tr');
    const act = btn.getAttribute('data-action');
    if (act === 'uredi')   zacniUrejanje(tr);
    if (act === 'shrani')  shraniUrejanje(tr);
    if (act === 'preklic') preklicUrejanja(tr);
    if (act === 'brisi')   brisi(tr);
  });

  // ===== PONASTAVI (3G) =====
  function ponastavi() {
    if (rezBody) rezBody.innerHTML = '';
    if (rezMsg) rezMsg.textContent = '';
    setText(preveriMsg, '', null);
    setText(dodajMsg, '', null);
    if (inpPreveri) inpPreveri.value = '';
    // inpNovo pustimo, opis se čisti ob dodajanju
  }
  btnPonastavi?.addEventListener('click', (ev) => { ev.preventDefault(); ponastavi(); });

  // ===== števec =====
  async function refreshStevec() {
    const el = $('stevecHome'); if (!el) return;
    try {
      const r = await fetch('/stevec_gesel.txt', { cache: 'no-store' });
      if (r.ok) { el.textContent = (await r.text()).trim() || '—'; return; }
      throw new Error('TXT ni dosegljiv');
    } catch {
      try {
        const j = await httpGet('/stevec_gesel');
        el.textContent = (j.count ?? j.stevec ?? '—');
      } catch {
        el.textContent = '—';
      }
    }
  }
  refreshStevec();

})();
</script>
{% endraw %}
{% endblock %}
