{% extends "base.html" %}

{% block title %}Administracija VUS{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Administracija VUS</h2>
    <span class="text-primary fw-bold">Gesel v bazi: <span id="stevec-gesel"></span></span>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">🔍 Preveri geslo</h5>
          <form id="preveri-form">
            <input type="text" class="form-control mb-2" id="preveri-vnos" placeholder="Vnesi geslo za preverjanje" required>
            <button class="btn btn-primary w-100" type="submit">Preveri</button>
          </form>
          <div id="preveri-rezultat" class="mt-2"></div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">↕️ Male ↔ Velike črke</h5>
          <input type="text" id="geslo-oblikuj" class="form-control mb-2" placeholder="Vnesi izraz">
          <button class="btn btn-dark w-100 mb-2" onclick="zamenjajMaleVelike()">Zamenjaj male/velike</button>
          <div><strong>Rezultat:</strong> <div id="rezultat-oblikuj"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">➕ Dodaj geslo</h5>
          <form id="dodaj-form">
            <input type="text" class="form-control mb-2" id="geslo" placeholder="Novo geslo" required>
            <textarea class="form-control mb-2" id="opis" placeholder="Opis" required></textarea>
            <button class="btn btn-success w-100" type="submit">Dodaj</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">📄 Opis s presledki</h5>
          <textarea id="opis-podcrtaji" class="form-control mb-2" rows="3" placeholder="npr. mesto v Braziliji"></textarea>
          <button class="btn btn-warning w-100" onclick="pretvoriOpis()">PRETVORI V PODČRTAJE</button>

          <div class="mt-3">
            <strong>Rezultat:</strong>
            <div class="input-group mt-1">
              <textarea id="rezultat-podcrtaji" class="form-control" rows="2" readonly></textarea>
              <button class="btn btn-outline-secondary" type="button" onclick="kopirajRezultat()">Kopiraj</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">💬 Zamenjaj izraz</h5>

      <form id="zamenjaj-form" class="row g-2">
        <div class="col-md-5">
          <input type="text" class="form-control" id="original" placeholder="Izvirni izraz" required>
        </div>
        <div class="col-md-5">
          <input type="text" class="form-control" id="zamenjava" placeholder="Nadomestni izraz" required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-warning w-100">Zamenjaj</button>
        </div>
      </form>

      <hr class="mt-3">
      <div class="row align-items-center g-2">
        <div class="col-md-8">
          <small id="arhivStatus" class="text-muted"></small>
        </div>
        <div class="col-md-4 text-md-end">
          <button id="btnArhiviraj" type="button" class="btn btn-warning">
            📂 Arhiviraj križanke v mesečne mape
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function pretvoriOpis() {
  const opis = document.getElementById('opis-podcrtaji').value;
  const rezultat = opis
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .toLowerCase()
    .replace(/[–—−]/g, '-')
    .replace(/[^a-z0-9\s]/g, '')
    .replace(/-/g, ' ')
    .replace(/\s+/g, '_')
    .substring(0, 64);
  document.getElementById('rezultat-podcrtaji').value = rezultat;
}

function zamenjajMaleVelike() {
  const polje = document.getElementById('geslo-oblikuj');
  const val = polje.value;
  const rezultat = [...val].map(c => c === c.toUpperCase() ? c.toLowerCase() : c.toUpperCase()).join('');
  polje.value = rezultat;
  document.getElementById('rezultat-oblikuj').textContent = rezultat;
}

function kopirajRezultat() {
  const polje = document.getElementById('rezultat-podcrtaji');
  polje.select();
  polje.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(polje.value)
    .then(() => alert("Besedilo skopirano."))
    .catch(() => alert("Napaka pri kopiranju."));
}

// === ŠTEVEC GESEL ===
function osveziStevecGesel() {
  fetch('/stevec_gesel')
    .then(resp => resp.json())
    .then(data => {
      document.getElementById('stevec-gesel').textContent = data.stevilo_gesel;
    })
    .catch(() => {
      document.getElementById('stevec-gesel').textContent = 'napaka';
    });
}
window.addEventListener('DOMContentLoaded', osveziStevecGesel);

// === DODAJANJE GESEL ===
const dodajForm = document.getElementById('dodaj-form');
dodajForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const geslo = document.getElementById('geslo').value;
  const opis = document.getElementById('opis').value;
  fetch('/dodaj_geslo', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ geslo, opis })
  })
  .then(resp => resp.json())
  .then(data => {
    alert(data.sporocilo);
    dodajForm.reset();
    osveziStevecGesel();
  });
});

// === ZAMENJAVA IZRAZA ===
const zamenjajForm = document.getElementById('zamenjaj-form');
zamenjajForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const original = document.getElementById('original').value;
  const zamenjava = document.getElementById('zamenjava').value;
  fetch('/zamenjaj', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ original, zamenjava })
  })
  .then(resp => resp.json())
  .then(data => {
    alert(`Zamenjanih: ${data.spremembe}`);
    zamenjajForm.reset();
  });
});

// === PREVERJANJE GESEL ===
const preveriForm = document.getElementById('preveri-form');
preveriForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const vnos = document.getElementById('preveri-vnos').value;
  fetch('/preveri', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ geslo: vnos })
  })
  .then(resp => resp.json())
  .then(data => {
    const rezultat = document.getElementById('preveri-rezultat');
    rezultat.innerHTML = '';

    if (!data.obstaja) {
      rezultat.textContent = "❌ Gesla ni v bazi.";
      rezultat.style.color = 'red';
      return;
    }
    rezultat.style.color = 'black';

    data.gesla.forEach(g => {
      const row = document.createElement('div');
      row.className = 'text-dark mb-1';

      const check = document.createTextNode('✅ ');
      const strong = document.createElement('strong');
      strong.textContent = g.geslo;

      const dash = document.createTextNode(' – ');
      const opisNode = document.createTextNode(g.opis);

      const btnUredi = document.createElement('button');
      btnUredi.type = 'button';
      btnUredi.className = 'btn btn-sm btn-outline-secondary ms-2';
      btnUredi.textContent = 'Uredi';
      btnUredi.addEventListener('click', () => urediGeslo(g.id, g.opis));

      const btnBrisi = document.createElement('button');
      btnBrisi.type = 'button';
      btnBrisi.className = 'btn btn-sm btn-danger ms-1';
      btnBrisi.textContent = 'Briši';
      btnBrisi.addEventListener('click', () => izbrisiGeslo(g.id));

      row.append(check, strong, dash, opisNode, btnUredi, btnBrisi);
      rezultat.appendChild(row);
    });
  });
});

// === UREJANJE IN BRISANJE GESEL ===
function urediGeslo(id, opis) {
  const novo = prompt("Popravi opis:", opis);
  if (novo !== null) {
    fetch('/uredi_geslo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, opis: novo })
    })
    .then(resp => resp.json())
    .then(data => {
      alert(data.sporocilo);
      document.getElementById('preveri-form').dispatchEvent(new Event('submit'));
    });
  }
}

function izbrisiGeslo(id) {
  if (!confirm("Res želiš izbrisati geslo?")) return;
  fetch('/brisi_geslo', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id })
  })
  .then(resp => resp.json())
  .then(data => {
    alert(data.sporocilo);
    document.getElementById('preveri-form').dispatchEvent(new Event('submit'));
    osveziStevecGesel();
  });
}

// === GUMB: ARHIVIRAJ (kliče /api/ pot) ===
(() => {
  const btn = document.getElementById('btnArhiviraj');
  const out = document.getElementById('arhivStatus');
  if (!btn || !out) return;
  if (btn.dataset.bound === '1') return;
  btn.dataset.bound = '1';

  btn.addEventListener('click', async () => {
    const old = btn.textContent;
    btn.disabled = true;
    btn.textContent = '⏳ Arhiviram…';
    out.textContent = '';
    try {
      const r = await fetch('/api/admin/arhiviraj', {
        method: 'POST',
        credentials: 'same-origin'
      });
      const data = await r.json();
      if (!r.ok || !data?.ok) throw new Error(data?.error || `HTTP ${r.status}`);
out.textContent =
  `Premaknjenih: ${data.moved_count}, že obstajalo: ${data.skipped_existing_count}, prihodnost/nezrelo: ${data.skipped_future_count}.`;
    } catch (e) {
      out.textContent = '❌ Napaka pri arhiviranju. (' + e.message + ')';
      console.error(e);
    } finally {
      btn.disabled = false;
      btn.textContent = old;
    }
  });
})();
</script>

<!-- (neobvezno) blokiraj stare klice na /admin/arhiviraj -->
<script>
document.addEventListener('click', (e) => {
  const a = e.target.closest('a[href="/admin/arhiviraj"]');
  if (a) { e.preventDefault(); e.stopPropagation(); }
}, true);
document.addEventListener('submit', (e) => {
  const form = e.target;
  if (form && (form.action || '').endsWith('/admin/arhiviraj')) {
    e.preventDefault(); e.stopPropagation();
  }
}, true);
</script>
{% endblock %}
